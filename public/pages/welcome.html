<!DOCTYPE html>
<html lang="en">
<head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0" />

        <script type="text/javascript" src="http://code.jquery.com/jquery-1.10.2.js"></script> 
       <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.0/css/bootstrap.min.css" /> 
        <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">  
        <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
        
       <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.0/js/bootstrap.min.js"></script> 
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script> 
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>  

        <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/jquery.bootstrapvalidator/0.5.3/css/bootstrapValidator.min.css"/>
        <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/jquery.bootstrapvalidator/0.5.3/js/bootstrapValidator.min.js"> </script> 
        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.form/3.51/jquery.form.min.js"></script>


         <link href = "https://code.jquery.com/ui/1.12.0/themes/ui-lightness/jquery-ui.css"
         rel = "stylesheet">
         <script src = "https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>

         <link href="./public/css/jquery.comiseo.daterangepicker.css" rel="stylesheet">
         <link href="./public/css/welcome.css" rel="stylesheet">
         <script src="./public/js/jquery.comiseo.daterangepicker.js"></script>
          <!-- <script src="./public/js/welcome.js"></script> -->
         <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.3/moment.min.js"></script>
         <script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.3.0/mustache.min.js"></script>


        <script type="text/javascript">

          $(function() {
             $( "#datepicker-13" ).datepicker({dateFormat: "yy-mm-dd"
                          
                                  });     
         });

          $(function() { $("#e2").daterangepicker({
                   datepickerOptions : {
                   numberOfMonths : 2
               }
          }); });

          
         $(document).ready(function(){ 

          document.querySelector("#createdon").valueAsDate = new Date();
          $("#toreturn").hide();
          $("#form1").hide();
          $("#viewform").hide();
          $("#trialtable").hide();
          $('#returnstable').hide();

          $("#expenseformbutton").click(function(){
                $('#returnstable').hide();
                $("#viewform").hide();
                 $("#trialtable").hide();
                $("#form1").fadeToggle("slow");

          });
          
          $('#viewexpensebutton').click(function(){
                $('#returnstable').hide();
                $("#form1").hide();
                 $("#trialtable").hide();
                $("#viewform").fadeToggle("slow");

          });
          $('#viewreturnsbutton').click(function(){
                $("#form1").hide();
                 $("#viewform").hide();
                 $("#trialtable").hide();
                 $.ajax({
                    type: 'GET',
                    ContentType: 'application/json',
                    url: 'http://localhost:3000/returns',            
                    success: function(data) {

                             $("#returnstable").fadeToggle("slow"); 

                  }

          });
         });
         

         

         //expense form validation
          $('#addexpenseform').bootstrapValidator();

        //   $("#addexpenseform").submit(function(event){
        //         event.preventDefault();
                
                
        //          var store =  $('#store').html();
                
        //          var amount = $('#amount').val();
        //          var spenton = $('#spenton').val();
        //           var createdon = $('#createdon').val();
        //           var dataSend = {};
        //           dataSend.store = $('#store').val();
        //           dataSend.amount = $('#amount').val();
        //           dataSend.spenton =$('#datepicker-13').val();
        //           dataSend.createdon = $('#createdon').val();
        //          // var dataSend = { 'store' :store , 'amount' : amount };
        //           //'amount' : amount , 'spenton' : spenton , 'createdon' : createdon 
               
        //         $.ajax({
        //             type: 'POST',
        //             data: JSON.stringify(dataSend),
        //             ContentType: 'application/json',
        //             url: 'http://localhost:3000/addexpense',            
        //             success: function(data) {
                     
        //                  // alert("expense added")
        //                   console.log(JSON.stringify(data));
        //                    }
        //       });


        // }); 
// $("#addexpenseform").submit(function(event){
//         event.preventDefault();
//         var form  = $('#addexpenseform')[0];
//         var data = new FormData(form);
//         $.post("/addexpense", function(data){
//             $( ".result" ).html( JSON.stringify(data) );
//         });
//     });

          $("#formoid").submit(function(event) {
               event.preventDefault();
               var data = $('#e2').val()
               $.ajax({
                    type: 'POST',
                    data:  {'data': data},
                    ContentType: 'application/json',
                    url: 'http://localhost:3000/viewexpense',            
                        success: function(data) {
                          var obj = JSON.parse(data);
                          console.log(obj);
                          // var object =  {'objectr': obj};
                          // var total = 0;
                          // for (i = 0; i < obj.length; i++) { 
                          //        total += obj[i].amount;  
                          //      }
                          // var template = $("#mp_template").html();
                          // var text = Mustache.render(template, object);
                         
                          
                          //console.log(total);
                    //$("#trialtable").html(text);
                    // $("#total").html(total);
                    // $('tr td:nth-child(1)').hide();
                     //$("#trialtable").fadeToggle("slow");



      var tbl ='';

      tbl+='<table class = "table table-responsive-lg">';
      tbl+='<tr>';
      tbl+='<th scope="col" class="text-white bg-success expensetable">STORE</th><th scope="col" class="text-white bg-success expensetable">ITEM</th><th scope="col" class="text-white bg-success expensetable">AMOUNT</th><th scope="col" class="text-white bg-success expensetable">PURCHASE DATE</th><th scope="col" class="text-white bg-success expensetable">CATEGORY</th><th scope="col" class="text-white bg-success expensetable">TO RETURN</th><th scope="col" class="text-white bg-success expensetable">NOTES</th><th scope="col" class="text-white bg-success expensetable">RECEIPT</th><th scope="col" class="text-white bg-success expensetable">Options</th>' ;
                     //trying editable table : 
    $.each(obj, function(index, val) 
      {
        
        var row_id = obj[index].expenseid;
        var return_mark = ""
        if(obj[index].toreturn===0)
        {
          return_mark="No" ;
        } else
        {
           return_mark="Yes" ;
        }
       
        //loop through ajax row data
        tbl +='<tr row_id="'+row_id+'">';
          tbl +='<td ><div class="text-white expensetable row_data" edit_type="click" col_name="store">'+obj[index].Store+'</div></td>';
          tbl +='<td ><div class="row_data text-white expensetable" edit_type="click" col_name="item">'+obj[index].item+'</div></td>';
          tbl +='<td ><div class="text-white expensetable row_data" edit_type="click" col_name="amount">'+obj[index].amount+'</div></td>';
          tbl +='<td ><div class="text-white expensetable row_data" edit_type="click" col_name="purchasedate">'+obj[index].purchasedate+'</div></td>';
          tbl +='<td ><div class="text-white expensetable row_data" edit_type="click" col_name="category">'+obj[index].category+'</div></td>';
          tbl +='<td ><div class="text-white expensetable row_data" edit_type="click" col_name="toreturn">'+return_mark+'</div></td>';
          
          tbl +='<td ><div class="text-white expensetable row_data" edit_type="click" col_name="notes">'+obj[index].notes+'</div></td>'; 
          tbl +='<td ><div class="text-white expensetable " edit_type="click" col_name="receiptimg"><a class="button btn btn-success btnn_try" href="'+obj[index].receiptimg+'"'+'+>View</a></div></td>';
          //--->edit options > start
          tbl +='<td>';
           
          tbl +='<a href="#" class=" button btn btn-success text-white expensetable  btn_edit btnn_try" row_id="'+row_id+'" > Edit</a>';

            //only show this button if edit button is clicked
            tbl +='<a href="#" class=" button btn btn-success text-white expensetable btnn_try btn_save" row_id="'+row_id+'" > Save</a>';
          // tbl +='<span class="btn_save text-white expensetable btn btn-success btn-sm" id="save"> <a href="#" class="btn text-white expensetable"  row_id="'+row_id+'"> Save</a> </span>';
          tbl +='<a href="#" class=" button btn btn-success text-white expensetable btnn_try btn_cancel" row_id="'+row_id+'" > Cancel</a>';
          // tbl +='<span class="btn_cancel text-white expensetable btn btn-success btn-sm"> <a href="#" class="btn text-white expensetable" row_id="'+row_id+'"> Cancel</a> </span>';

          tbl +='</td>';
          //--->edit options > end
          
        tbl +='</tr>';
        
      });
           
       tbl +='</table>'
           $("#trialtable").html(tbl); 
           $("#trialtable").fadeToggle("slow");     
           $(document).find('.btn_save').hide();
           $(document).find('.btn_cancel').hide();   


//                      //--->make div editable > start
//           $(document).on('click', '.row_data', function(event) 
//           {
//             event.preventDefault(); 

//             if($(this).attr('edit_type') == 'button')
//             {
//               return false; 
//             }

//             //make div editable
//             $(this).closest('div').attr('contenteditable', 'true');
//             //add bg css
//             $(this).addClass('bg-gradient-info').css('padding','3px');

//             $(this).focus();
//           })  
// //--->make div editable > end  


                          //--->button > edit > start 
                          $(document).on('click', '.btn_edit', function(event) 
                          {
                            event.preventDefault();
                            var tbl_row = $(this).closest('tr');

                            var row_id = tbl_row.attr('row_id');

                            tbl_row.find('.btn_save').show();
                            tbl_row.find('.btn_cancel').show();

                            //hide edit button
                            tbl_row.find('.btn_edit').hide(); 

                            //make the whole row editable
                            tbl_row.find('.row_data')
                            .attr('contenteditable', 'true')
                            .attr('edit_type', 'button')
                            .addClass('bg-gradient-info')
                            .css('padding','3px')

                            //--->add the original entry > start
                            tbl_row.find('.row_data').each(function(index, val) 
                            {  
                              //this will help in case user decided to click on cancel button
                              $(this).attr('original_entry', $(this).html());
                            });     
                            //--->add the original entry > end

                          });

                             //--->button > cancel > start  
                          $(document).on('click', '.btn_cancel', function(event) 
                          {
                            event.preventDefault();

                            var tbl_row = $(this).closest('tr');

                            var row_id = tbl_row.attr('row_id');

                            //hide save and cacel buttons
                            tbl_row.find('.btn_save').hide();
                            tbl_row.find('.btn_cancel').hide();

                            //show edit button
                            tbl_row.find('.btn_edit').show();

                            //make the whole row editable
                            tbl_row.find('.row_data')
                            .attr('contenteditable', 'false')
                            .attr('edit_type', 'button')
                            .removeClass('bg-gradient-info')
                            .css('padding','')

                            // //make the whole row editable
                            // tbl_row.find('.row_data')
                            // .attr('edit_type', 'click')  
                            // .removeClass('bg-gradient-info')
                            // .css('padding','') 

                            tbl_row.find('.row_data').each(function(index, val) 
                            {   
                              $(this).html( $(this).attr('original_entry') ); 
                            });  
                          });
                          //--->button > cancel > end



                                          //--->save whole row entery > start 
                                          $(document).on('click', '.btn_save', function(event) 
                                          {
                                            event.preventDefault();
                                            var tbl_row = $(this).closest('tr');

                                            var row_id = tbl_row.attr('row_id');

                                            
                                            //hide save and cacel buttons
                                            tbl_row.find('.btn_save').hide();
                                            tbl_row.find('.btn_cancel').hide();

                                            //show edit button
                                            tbl_row.find('.btn_edit').show();


                                            //make the whole row editable
                                            tbl_row.find('.row_data')
                                            .attr('edit_type', 'click') 
                                            .removeClass('bg-gradient-info')
                                            .css('padding','') 

                                            //--->get row data > start
                                            var arr = {}; 
                                            tbl_row.find('.row_data').each(function(index, val) 
                                            {   
                                              var col_name = $(this).attr('col_name');  
                                              var col_val  =  $(this).html();
                                              if(col_name === "toreturn" &&  col_val ==="Yes"){
                                                col_val = 1;
                                              }
                                              arr[col_name] = col_val;
                                            });
                                            //--->get row data > end

                                            //use the "arr" object for your ajax call
                                            $.extend(arr, {row_id:row_id});

                                             $.ajax({
                                                              type: 'POST',
                                                              data:  arr,
                                                              ContentType: 'application/json',
                                                              url: 'http://localhost:3000/updateexpense',            
                                                                  success: function(data) {

                                                                    console.log(data);

                                                                  }

                                                     });

                                            //out put to show
                                            
                                           
                                             

                                          });
//--->save whole row entery > end

                           
                        }
                    });
       
      });
        
    })   
        </script>

        </head>
        <style type="text/css">

        .btnn_try{
            border-radius: 25px 50px;
            padding: 10px 12px;
        }
        
        </style>
<body>

<!-- ===================================================Nav bar=================================================================== -->
	<div class="container">
   <nav class="navbar navbar-inverse navbar-expand-sm rounded">
  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav mr-auto">
      <li> 
       <button class="btn btn-success buttonborder mr-sm-4 navbarspace" onclick="window.location.href='/home'">Home
       <span class="sr-only">(current)</span></button>
      </li>
      <li> 
       <button class="btn btn-success buttonborder mr-sm-4 navbarspace" type="" id="expenseformbutton">Add Expense</button>
      </li>
      <li class="nav-item">
        <button class="btn btn-success buttonborder  mr-sm-4 navbarspace" type="" id= "viewexpensebutton"> View Expenses </button>
      </li>
      <!-- <li class="nav-item">
        <button  class="btn btn-success buttonborder  mr-sm-4 navbarspace" type="" onclick="window.location.href='/welcome'" > Receipts </button>
      </li> -->
      <li class="nav-item">
        <button  class="btn btn-success buttonborder  mr-sm-4 navbarspace" type="" id="viewreturnsbutton" > Returns </button>
      </li>
    </ul>
    <ul class="nav mr-auto">
      <li class="nav-item">
         <form class="form-inline" method="get" action="/logout">
        <button class="btn btn-success buttonborder  mr-sm-4 logoutbutton" type="submit" > Logout <i class="fa fa-sign-out ml-2"></i></button>
    </form>
    </li>
    </ul>
  </div>
</nav>
</div>

 
 

<!--  ==================================================Add expense form==========================================  -->
<div style="margin-left: 150px;" class="container " id="form1">
  <h3 align="center" style="color:white!important;
            "> Enter the Expense Information </h3>
  <form id="addexpenseform" method="post" action="/addexpense" enctype="multipart/form-data"
      data-bv-message="This value is not valid"
      data-bv-feedbackicons-valid="fa fa-check"
      data-bv-feedbackicons-invalid="fa fa-remove"
      data-bv-feedbackicons-validating="fa fa-refresh"
      >
      <div class="form-group  expenseform">
        
             <div class="input-group my-3" >
                   <label class="col-form-label col-sm-4 formlabel " >Store : </label>
                   <div class = "col-sm-4 right-inner-addon" ><input type="text"  autocomplete="off" id= "store" name="store" class="form-control" placeholder="Enter the store name"
                     data-bv-notempty="true" data-bv-notempty-message="The store name is required and cannot be empty">
                   <div id="messages"></div>
                   <!-- <div class="input-group-prepend">
                        <span class="input-group-text" ><i class="fa fa-usd"></i></span>
                   </div> --> 
                   </div>
            </div>
            <div class="input-group my-3" >
                   <label class="col-form-label col-sm-4 formlabel " >Item : </label>
                   <div class = "col-sm-4 right-inner-addon" ><input type="text"  autocomplete="off" id= "item" name="item" class="form-control" placeholder="Enter the item"
                     data-bv-notempty="false" >
                   <div id="messages"></div>
                   <!-- <div class="input-group-prepend">
                        <span class="input-group-text" ><i class="fa fa-usd"></i></span>
                   </div> --> 
                   </div>
            </div>

            <div class="input-group  mr-2 mb-2 my-3" >
                   <label class="col-form-label col-sm-4 formlabel" >Amount$: </label>
                   <div class = "col-sm-4 right-inner-addon" ><input id= "amount" type="number" autocomplete="off" step="0.1" name="amount" class="form-control" placeholder="Enter the amount"
                     data-bv-notempty="true" data-bv-notempty-message="The amount is required and cannot be empty">
                   <div id="messages"></div>
                   <!-- <div class="input-group-prepend">
                        <span class="input-group-text" ><i class="fa fa-usd"></i></span>
                   </div> --> 
                   </div>
            </div>


            <div class="input-group  mr-2 mb-2 my-3" >
                   <label class="col-form-label col-sm-4 formlabel" >Date Of Purchase: </label>

                   <div class = "col-sm-4 right-inner-addon" >
                     <input  type="text" id = "datepicker-13" autocomplete="off"  name = "spenton" class="form-control" 
                     data-bv-notempty="true" data-bv-notempty-message="The date of purchase is required and cannot be empty">
                     <div id="messages"></div>
                   </div>
            </div>

            <div class="input-group  mr-2 mb-2 my-3" >
                   <label class="col-form-label col-sm-4 formlabel " >Expense Created on: </label>

                   <div class = "col-sm-4" >
                    <input  type="date" id="createdon" readonly name = "createdon" class="form-control"
                    >
                    <div id="messages"></div>
            </div>
            </div>
            <div class="input-group  mr-2 mb-2 my-3" id="toreturn" >
                   <label class="col-form-label col-sm-4 my-1 formlabel" > to return: </label>

                   <div class = "col-sm-3 my-3" ><input type="checkbox" name = "toreturnmark" id="toreturn" class="form-control">
                    <div id="messages"></div>
                   </div>
            </div>
            <div class="input-group my-3" >
                   <label class="col-form-label col-sm-4 formlabel " >Notes : </label>
                   <div class = "col-sm-4 right-inner-addon" ><input type="textarea"  autocomplete="off" id= "notes" name="notes" class="form-control" placeholder="Enter notes if any"
                     data-bv-notempty="false" >
                   <div id="messages"></div>
                   <!-- <div class="input-group-prepend">
                        <span class="input-group-text" ><i class="fa fa-usd"></i></span>
                   </div> --> 
                   </div>
            </div>

            <div class="input-group  mr-2 mb-2 my-3">
                  <label class="col-form-label col-sm-4 my-1 formlabel" > Category: </label>
                  <div class = "col-sm-4 my-1" >
                  <select class="form-control" name="category" id="category">
                        <option>Entertainment</option>
                        <option>Food</option>
                        <option>Education</option>
                        <option>Clothing</option>
                        <option>Others</option>
                  </select>
                  <div id="messages"></div>
                 </div>
            </div>

            <div class="input-group  mr-2 mb-2 my-2">
                   <label class="col-form-label col-sm-4 my-1 formlabel" > Receipt: </label>

                   <div class = "col-sm-4 my-3" ><input type="file" id="file" name="imgfile" multiple class="form-control">
                    <div id="messages"></div>
                   </div>
            </div>

           <div class="input-group  mr-2 mb-2 my-3">
                   <div class = "col-sm-2 my-3" >
                         <button class="btn btn-success expensebutton buttonborder" type="submit" id="expensebutton" style="font-size : 16px;"> Add Expense <i class="fa fa-plus ml-2"></i></button>
                   </div>
            
               
        </div>   
        <div class="result"></div>      
  </div>    
  </form>
</div>


<!-- ============================================================ View Expenses form=========================================================> -->
           <div style="margin-left: 150px;" class="container " id="viewform">

            <form  id="formoid">
              <div class="form-group row">
                    <div class="input-group  mr-2 mb-2 my-2">
                   <label class="col-form-label col-sm-4 my-3 viewformlabel" style="font-size: 16px"> Enter the range: </label>

                    <div class = "col-sm-4 my-3" > <input autocomplete="off" id="e2" name="e2"> 
                    <div id="messages"></div>
                   </div>
            </div>


            <div class="input-group  mr-2 mb-2 my-2">
                   <div class = "col-sm-2 my-1" >
                         <button class="btn btn-success expensebutton buttonborder" type="submit" id="viewexpenserangebutton" style="font-size : 16px;" > view<i class="fa fa-search ml-2"></i></button>
                   </div>
            
               
             </div> 

              </div>
              

            </form>
          </div>
    
        <div class="container" id="trialtable">
          </div>


  <!-- ===================================================== Handle Returns ============================================================= -->
         <div style="margin-left: 150px;" class="container " >

            <div class="container" id="returnstable"> returns table
          </div>
          </div>
    
        


</body>


</html>